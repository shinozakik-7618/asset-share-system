<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è³‡ç”£å±¥æ­´ - æ‹ ç‚¹è³‡ç”£ã‚·ã‚§ã‚¢ã‚·ã‚¹ãƒ†ãƒ </title>
  <link rel="stylesheet" href="/css/style.css">
  
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <div class="header-title">ğŸ“œ è³‡ç”£å±¥æ­´</div>
      <div class="header-user">
        <button class="btn" onclick="history.back()" style="padding: 8px 16px; font-size: 14px; background: white; color: #1976d2; border: 2px solid #1976d2; margin-right: 10px;">â† æˆ»ã‚‹</button>
        <button class="btn" style="padding: 8px 16px; font-size: 14px; background: #1976d2; color: white; border: 2px solid white;" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </header>

  <main class="container main-content">
    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
      <h2 style="margin: 0 0 10px 0; color: #333;">è³‡ç”£æƒ…å ±</h2>
      <div id="assetInfo" style="color: #666;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <h2 style="margin: 0 0 20px 0; color: #333;">ğŸ“‹ å±¥æ­´ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h2>
      <div id="historyTimeline">
        <p style="text-align: center; color: #999; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</p>
      </div>
    </div>
  </main>

  <script src="/js/config.js"></script>
  <script src="/js/common.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/asset-history.js"></script>
  <script>
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰è³‡ç”£IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const assetId = urlParams.get('id');

    if (!assetId) {
      alert('è³‡ç”£IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      window.location.href = '/my-items.html';
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
        await loadAssetInfo();
        await loadHistory();
      } else {
        window.location.href = '/index.html';
      }
    });

    // è³‡ç”£æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
    async function loadAssetInfo() {
      try {
        const doc = await firebase.firestore()
          .collection('assets')
          .doc(assetId)
          .get();
        
        if (!doc.exists) {
          alert('è³‡ç”£ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          window.location.href = '/my-items.html';
          return;
        }

        const asset = doc.data();
        document.getElementById('assetInfo').innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px;">
            <div>
              <div style="font-size: 12px; color: #999; margin-bottom: 5px;">è³‡ç”£å</div>
              <div style="font-weight: 600; color: #333;">${asset.name}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ã‚«ãƒ†ã‚´ãƒª</div>
              <div style="font-weight: 600; color: #333;">${asset.largeCategoryName || 'æœªè¨­å®š'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #999; margin-bottom: 5px;">æ‹ ç‚¹</div>
              <div style="font-weight: 600; color: #333;">${asset.baseName || 'æœªè¨­å®š'}</div>
            </div>
            <div>
              <div style="font-size: 12px; color: #999; margin-bottom: 5px;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
              <div style="font-weight: 600; color: ${asset.status === 'available' ? '#4caf50' : '#999'};">
                ${asset.status === 'available' ? 'âœ… å…¬é–‹ä¸­' : 'â¸ï¸ éå…¬é–‹'}
              </div>
            </div>
          </div>
        `;
      } catch (error) {
        console.error('è³‡ç”£æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('assetInfo').innerHTML = '<p style="color: #f44336;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }

    // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    async function loadHistory() {
      try {
        const history = await getAssetHistory(assetId);
        const html = renderHistoryTimeline(history);
        document.getElementById('historyTimeline').innerHTML = html;
      } catch (error) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('historyTimeline').innerHTML = '<p style="color: #f44336; text-align: center;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
      }
    }
  </script>
</body>
</html>
